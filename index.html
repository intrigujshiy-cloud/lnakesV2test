<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Planet Game Multi-Lang + Math</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Comfortaa:wght@700&family=Bungee&family=Kelly+Slab&family=Monoton&family=Pacifico&family=Ruslan+Display&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <style>
        /* –ó–ê–©–ò–¢–ê */
        body { 
            margin: 0; overflow: hidden; font-family: sans-serif; background: #1a1a1a; 
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; 
        }
        canvas { display: block; }
        
        #auth-screen { position: fixed; inset: 0; background: #050505; z-index: 20000; display: flex; flex-direction: column; align-items: center; justify-content: center; background-image: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #000000 100%); color: #00f2ff; }
        .lock-icon { font-size: 60px; margin-bottom: 20px; animation: float 3s ease-in-out infinite; }
        .auth-box { background: rgba(20, 20, 30, 0.9); padding: 40px; border-radius: 20px; border: 2px solid #333; text-align: center; box-shadow: 0 0 50px rgba(0, 242, 255, 0.1); width: 300px; }
        .auth-title { font-size: 18px; margin-bottom: 20px; letter-spacing: 2px; text-transform: uppercase; color: #fff; font-weight: bold; }
        .auth-input { user-select: auto; width: 100%; padding: 15px; background: #000; border: 1px solid #444; color: #00f2ff; font-size: 20px; text-align: center; border-radius: 10px; margin-bottom: 20px; outline: none; letter-spacing: 5px; transition: 0.3s; box-sizing: border-box; }
        .auth-input:focus { border-color: #00f2ff; box-shadow: 0 0 15px rgba(0, 242, 255, 0.3); }
        .auth-btn { width: 100%; padding: 15px; background: #00f2ff; color: #000; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; transition: 0.3s; text-transform: uppercase; }
        .auth-btn:hover { transform: scale(1.05); box-shadow: 0 0 20px #00f2ff; }
        .error-msg { color: #ff0055; margin-top: 15px; font-size: 14px; display: none; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }

        .brand-logo { position: absolute; bottom: 10px; left: 10px; z-index: 100; display: block; cursor: pointer; animation: pulse-logo 3s infinite; }
        .brand-logo img { height: 115px; width: auto; filter: drop-shadow(0 0 2px #ffffff) drop-shadow(0 0 5px #ffd700) drop-shadow(0 0 15px #ffb300) drop-shadow(0 0 30px rgba(255, 179, 0, 0.4)); transition: all 0.3s ease; -webkit-user-drag: none; }
        .brand-logo:hover img { transform: scale(1.05); filter: drop-shadow(0 0 5px #ffffff) drop-shadow(0 0 10px #ffd700) drop-shadow(0 0 25px #ffb300) drop-shadow(0 0 40px rgba(255, 179, 0, 0.6)); }
        @keyframes pulse-logo { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        #panel {
            position: absolute; left: 10px; top: 10px; width: 340px; 
            background: rgba(0,0,0,0.95); padding: 15px; border-radius: 10px;
            z-index: 100; color: white; border: 1px solid #444;
            max-height: 95vh; overflow-y: auto; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: none;
        }
        #turn-indicator {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            padding: 10px 20px; background: rgba(0,0,0,0.8); color: gold;
            border: 2px solid gold; border-radius: 20px;
            font-weight: bold;
            z-index: 50; display: none; font-size: 18px;
        }
        .input-wrap { position: relative; display: flex; align-items: center; margin-bottom: 8px; }
        .clear-btn { position: absolute; right: 5px; background: none; border: none; color: #888; cursor: pointer; font-size: 18px; font-weight: bold; padding: 0 5px; line-height: 1; z-index: 5; }
        .clear-btn:hover { color: #f44336; }
        .tasks-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .tasks-row div { flex: 1; }
        .tasks-row textarea { height: 80px; resize: none; user-select: auto; }
        .colors-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .colors-grid label { font-size: 10px; display: flex; flex-direction: column; }
        input, textarea, select { user-select: auto; width: 100%; background: #222; color: white; border: 1px solid #555; padding: 5px 25px 5px 5px; box-sizing: border-box; border-radius: 4px; }
        .neon-row { background: #333; padding: 10px; border-radius: 5px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        .btn { width: 100%; padding: 8px; margin-bottom: 5px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; color: white; }
        .size-settings { margin-bottom: 15px; }
        .half-width-sliders { display: flex; gap: 10px; }
        .half-width-sliders div { flex: 1; }
        .size-label { font-size: 11px; margin-bottom: 4px; display: block; }
        #font-preview { background: #444; padding: 10px; border-radius: 5px; text-align: center; margin-bottom: 10px; font-size: 18px; border: 1px solid #666; min-height: 25px; }
        #task-modal { 
            display: none; position: fixed; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.8); 
            width: 400px; min-height: 200px; padding: 30px; border-radius: 20px; 
            z-index: 10000; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
            border: 2px solid #f0e68c; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background-size: cover; background-position: center;
        }
        #task-modal.show { transform: translate(-50%, -50%) scale(1); display: block; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; font-weight: bold; line-height: 1; opacity: 0.7; }
        .close-modal:hover { opacity: 1; }
        #answer-input { user-select: auto; width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; font-size: 16px; border: 1px solid #ccc; background: white; color: #333; }
        #check-btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; color: white; }
        #victory-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(45deg, #ff9999, #ffcc99, #ffff99, #99ff99, #99ccff, #cc99ff); background-size: 400% 400%; animation: rainbowMove 6s ease infinite; z-index: 20000; flex-direction: column; justify-content: center; align-items: center; color: #444; text-align: center; cursor: pointer; }
        #confetti-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        @keyframes rainbowMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        .cup { font-size: 150px; z-index: 20001; position: relative; }
        #loading-msg { display:none; color: #4CAF50; font-size: 12px; margin-bottom: 5px; text-align: center; }
        @keyframes shake { 0%, 100% { transform: translate(-50%, -50%); } 20%, 60% { transform: translate(-53%, -50%); } 40%, 80% { transform: translate(-47%, -50%); } }
        .modal-error { animation: shake 0.4s ease-in-out !important; border: 3px solid #f44336 !important; }
    </style>
</head>
<body>

<div id="auth-screen">
    <div class="lock-icon">üîí</div>
    <div class="auth-box">
        <div class="auth-title">–ó–∞—â–∏—Ç–∞ –∞–≤—Ç–æ—Ä—Å–∫–∏—Ö –ø—Ä–∞–≤</div>
        <input type="password" id="pInput" class="auth-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥">
        <button class="auth-btn" onclick="cP()">–û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
        <div id="errMsg" class="error-msg">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</div>
    </div>
</div>

<div id="turn-indicator">–•–û–î –ò–ì–†–û–ö–ê: 1</div>

<div id="panel">
    <h3 style="margin:0 0 5px 0; color: #4CAF50;" data-t="editor_title">–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</h3>

    <div style="background:#222; padding:10px; border-radius:8px; border:1px solid #4CAF50; margin-bottom:15px;">
        <label style="font-size:10px; color:#4CAF50; font-weight:bold; display:block; margin-bottom:3px;">LANGUAGE / –Ø–ó–´–ö:</label>
        <select id="ui-language" onchange="changeLanguage()" style="margin-bottom: 8px; background: #000; border: 1px solid #666;">
            <option value="ru">–†—É—Å—Å–∫–∏–π üá∑üá∫</option>
            <option value="en">English üá∫üá∏</option>
            <option value="es">Espa√±ol üá™üá∏</option>
            <option value="de">Deutsch üá©üá™</option>
            <option value="fr">Fran√ßais üá´üá∑</option>
        </select>

        <label style="font-size:10px; color:#4CAF50; font-weight:bold; display:block; margin-bottom:3px;" data-t="lbl_font">–®–†–ò–§–¢ –ò–ì–†–´:</label>
        <select id="game-font" onchange="update()" style="margin-bottom: 5px; background: #000; border: 1px solid #666;">
            <option value="Arial">–°—Ç–∞–Ω–¥–∞—Ä—Ç (Arial)</option>
            <option value="'Comfortaa', sans-serif">–ú—è–≥–∫–∏–π (Comfortaa)</option>
            <option value="'Press Start 2P', cursive">–ü–∏–∫—Å–µ–ª—å–Ω—ã–π (8-bit)</option>
            <option value="'Bungee', cursive">–ñ–∏—Ä–Ω—ã–π (Bungee)</option>
            <option value="'Kelly Slab', cursive">–¢–µ—Ö–Ω–æ (Kelly Slab)</option>
            <option value="'Monoton', cursive">–†–µ—Ç—Ä–æ-–ù–µ–æ–Ω (Monoton)</option>
            <option value="'Pacifico', cursive">–†—É–∫–æ–ø–∏—Å–Ω—ã–π (Pacifico)</option>
            <option value="'Ruslan Display', cursive">–°–ª–∞–≤—è–Ω—Å–∫–∏–π (Ruslan)</option>
        </select>
        <div id="font-preview" style="font-size:12px; padding:5px; margin-bottom:10px;">TEXT 123 –¢–ï–ö–°–¢</div>
        
        <div style="display:flex; align-items:center; justify-content:space-between; background:#111; padding:5px; border-radius:4px;">
            <label style="font-size:11px; color:#fff;" data-t="lbl_latex">MATH / LATEX ($$):</label>
            <input type="checkbox" id="latex-on" onchange="update()" style="width:20px;">
        </div>
    </div>
    <div class="input-wrap"><input type="text" id="bg-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –§–û–ù –ò–ì–†–´" oninput="update()"><button class="clear-btn" onclick="clearInp('bg-url')">√ó</button></div>
    <div class="input-wrap"><input type="text" id="modal-bg-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –§–û–ù –û–ö–ù–ê (URL)" oninput="update()"><button class="clear-btn" onclick="clearInp('modal-bg-url')">√ó</button></div>
    <div class="input-wrap"><input type="text" id="music-url" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –ú–£–ó–´–ö–£ (MP3)" oninput="update()"><button class="clear-btn" onclick="clearInp('music-url')">√ó</button></div>
    
    <div class="neon-row">
        <label style="font-size:12px; font-weight:bold;" data-t="lbl_players">–ö–û–õ-–í–û –ò–ì–†–û–ö–û–í:</label>
        <select id="p-count" onchange="update()" style="width:60px; margin:0;"><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option></select>
    </div>

    <div class="colors-grid">
        <label><span data-t="lbl_trail">–•–í–û–°–¢ –§–ò–®–ö–ò:</span> <select id="trail-type" onchange="update()"><option value="match" data-t="opt_match">–í —Ü–≤–µ—Ç</option><option value="rainbow" data-t="opt_rainbow">–†–ê–î–£–ì–ê</option><option value="custom" data-t="opt_custom">–°–≤–æ–π —Ü–≤–µ—Ç</option><option value="none" data-t="opt_none">–ù–µ—Ç</option></select></label>
        <label><span data-t="lbl_trail_color">–¶–í–ï–¢ –•–í–û–°–¢–ê</span> <input type="color" id="c-trail" value="#ffffff" oninput="update()" style="height:25px;"></label>
    </div>

    <label style="font-size:11px" data-t="lbl_dice">–°–ö–ò–ù –ö–£–ë–ò–ö–ê:</label>
    <select id="dice-skin" onchange="update()" style="margin-bottom: 8px;">
        <option value="classic" data-t="dice_classic">–ö–ª–∞—Å—Å–∏–∫–∞ (–ë–µ–ª—ã–π)</option>
        <option value="glass" data-t="dice_glass">–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π</option>
        <option value="neon" data-t="dice_neon">–ù–µ–æ–Ω–æ–≤—ã–π</option>
        <option value="gold" data-t="dice_gold">–ó–æ–ª–æ—Ç–æ–π</option>
    </select>

    <label style="font-size:11px; color:#4CAF50; font-weight:bold;" data-t="lbl_tokens">–°–ö–ò–ù–´ –§–ò–®–ï–ö:</label>
    <div class="colors-grid">
        <div class="input-wrap"><input type="text" id="t1" placeholder="–§–∏—à–∫–∞ 1" oninput="update()"><button class="clear-btn" onclick="clearInp('t1')">√ó</button></div>
        <div class="input-wrap"><input type="text" id="t2" placeholder="–§–∏—à–∫–∞ 2" oninput="update()"><button class="clear-btn" onclick="clearInp('t2')">√ó</button></div>
        <div class="input-wrap"><input type="text" id="t3" placeholder="–§–∏—à–∫–∞ 3" oninput="update()"><button class="clear-btn" onclick="clearInp('t3')">√ó</button></div>
        <div class="input-wrap"><input type="text" id="t4" placeholder="–§–∏—à–∫–∞ 4" oninput="update()"><button class="clear-btn" onclick="clearInp('t4')">√ó</button></div>
    </div>
    
    <div class="half-width-sliders" style="margin-bottom:10px;">
        <div><label class="size-label"><span data-t="lbl_w">–®–∏—Ä–∏–Ω–∞:</span> <span id="tw-val">60</span>px</label><input type="range" id="token-w" min="10" max="200" value="60" oninput="update()"></div>
        <div><label class="size-label"><span data-t="lbl_h">–í—ã—Å–æ—Ç–∞:</span> <span id="th-val">60</span>px</label><input type="range" id="token-h" min="10" max="200" value="60" oninput="update()"></div>
    </div>

    <div class="input-wrap"><input type="text" id="ladder-url" placeholder="URL –õ–µ—Å—Ç–Ω–∏—Ü—ã" oninput="update()"><button class="clear-btn" onclick="clearInp('ladder-url')">√ó</button></div>
    <div class="input-wrap"><input type="text" id="snake-url" placeholder="URL –ó–º–µ–∏" oninput="update()"><button class="clear-btn" onclick="clearInp('snake-url')">√ó</button></div>

    <div class="neon-row" style="display:block;">
        <label style="font-size:11px; color:#2196F3; font-weight:bold;">GOOGLE SHEETS (CSV):</label>
        <div class="input-wrap" style="margin-top:5px;"><input type="text" id="sheet-url" placeholder="Publish -> CSV..." oninput="update()"><button class="clear-btn" onclick="clearInp('sheet-url')">√ó</button></div>
        <div id="loading-msg">...</div>
        <button class="btn" style="background:#673ab7; font-size:12px;" onclick="loadFromGoogle()" data-t="btn_load">–ó–ê–ì–†–£–ó–ò–¢–¨ –í–û–ü–†–û–°–´</button>
    </div>

    <div class="tasks-row">
        <div><label style="font-size:10px" data-t="lbl_q">–í–û–ü–†–û–°–´</label><textarea id="qs" oninput="update()"></textarea></div>
        <div><label style="font-size:10px" data-t="lbl_a">–û–¢–í–ï–¢–´</label><textarea id="ans" oninput="update()"></textarea></div>
    </div>

    <div class="size-settings">
        <label class="size-label"><span data-t="lbl_cells">–ö–ª–µ—Ç–∫–∏:</span> <span id="sz-val">60</span>px</label><input type="range" id="cell-size" min="30" max="150" value="60" oninput="update()">
        <div class="half-width-sliders">
            <div><label class="size-label"><span data-t="lbl_ladders">–õ–µ—Å—Ç–Ω–∏—Ü—ã:</span> <span id="l-th-val">60</span>px</label><input type="range" id="ladder-th" min="10" max="250" value="60" oninput="update()"></div>
            <div><label class="size-label"><span data-t="lbl_snakes">–ó–º–µ–∏:</span> <span id="s-th-val">60</span>px</label><input type="range" id="snake-th" min="10" max="250" value="60" oninput="update()"></div>
        </div>
    </div>

    <select id="cell-shape" onchange="update()" style="margin-bottom: 8px;">
        <option value="circle" data-t="shape_circle">–ö—Ä—É–≥</option>
        <option value="square" data-t="shape_square">–ö–≤–∞–¥—Ä–∞—Ç</option>
        <option value="rect" data-t="shape_rect">–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</option>
    </select>

    <div class="neon-row"><label style="font-size:12px; font-weight:bold;">NEON EFFECT</label><input type="checkbox" id="neon-on" onchange="update()" checked style="width:20px;"></div>

    <div class="colors-grid">
        <label><span data-t="col_dots">–ö—Ä—É–∂–∫–∏</span> <input type="color" id="c-dots" value="#ffffff" oninput="update()" style="height:25px;"></label>
        <label><span data-t="col_bg">–¶–≤–µ—Ç –æ–∫–Ω–∞</span> <input type="color" id="c-bg" value="#fff9e6" oninput="update()" style="height:25px;"></label>
        <label><span data-t="col_txt">–¢–µ–∫—Å—Ç –æ–∫–Ω–∞</span> <input type="color" id="c-txt" value="#333333" oninput="update()" style="height:25px;"></label>
        <label><span data-t="col_btn">–ö–Ω–æ–ø–∫–∞</span> <input type="color" id="c-btn" value="#4CAF50" oninput="update()" style="height:25px;"></label>
    </div>

    <button id="link-btn" class="btn" style="background:#9c27b0" onclick="toggleLinkMode()" data-t="btn_link">–°–≤—è–∑–∞—Ç—å –∫—Ä—É–∂–∫–∏</button>
    <button class="btn" style="background:#ff9800" onclick="undo()" data-t="btn_undo">–û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è</button>
    <button class="btn" style="background:#2196F3" onclick="save()" data-t="btn_copy">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
    <button class="btn" style="background:#673ab7" onclick="getIframe()" data-t="btn_iframe">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ iFrame</button>
    <button class="btn" style="background:#f44336" onclick="if(confirm('Reset?')){location.reload();}" data-t="btn_reset">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
</div>

<a id="brandLink" href="#" target="_blank" class="brand-logo"><img id="brandImg" src="" alt=""></a>

<div id="victory-overlay" onclick="location.reload()"><canvas id="confetti-canvas"></canvas><h1 id="vic-title" style="font-size: 80px; margin: 0; position: relative; z-index: 20002;">VICTORY!</h1><div class="cup">üèÜ</div></div>

<div id="task-modal">
    <span class="close-modal" onclick="closeModal()">√ó</span>
    <h2 id="modal-status">–ó–ê–î–ê–ù–ò–ï!</h2>
    <div id="task-question" style="font-size:24px; margin-bottom:20px; font-weight:bold; word-wrap: break-word;"></div>
    <input type="text" id="answer-input">
    <button id="check-btn" onclick="checkAnswer()">CHECK</button>
</div>

<canvas id="cvs"></canvas>

<script>
    const cvs = document.getElementById('cvs'), ctx = cvs.getContext('2d'), cnfCvs = document.getElementById('confetti-canvas'), cnfCtx = cnfCvs.getContext('2d');
    let audioCtx = null; const bgMusic = new Audio(); bgMusic.loop = true;
    let actHist = []; // –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π
    
    // –°–õ–û–í–ê–†–¨ –ü–ï–†–ï–í–û–î–û–í
    const translations = {
        ru: {
            editor_title: "–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä",
            ph_bg: "–°—Å—ã–ª–∫–∞ –Ω–∞ –§–û–ù –ò–ì–†–´", ph_modal: "–°—Å—ã–ª–∫–∞ –Ω–∞ –§–û–ù –û–ö–ù–ê (URL)", ph_music: "–°—Å—ã–ª–∫–∞ –Ω–∞ –ú–£–ó–´–ö–£ (MP3)",
            lbl_players: "–ö–û–õ-–í–û –ò–ì–†–û–ö–û–í:", lbl_trail: "–•–í–û–°–¢ –§–ò–®–ö–ò:", lbl_trail_color: "–¶–í–ï–¢ –•–í–û–°–¢–ê",
            opt_match: "–í —Ü–≤–µ—Ç", opt_rainbow: "–†–ê–î–£–ì–ê", opt_custom: "–°–≤–æ–π —Ü–≤–µ—Ç", opt_none: "–ù–µ—Ç",
            lbl_dice: "–°–ö–ò–ù –ö–£–ë–ò–ö–ê:", dice_classic: "–ö–ª–∞—Å—Å–∏–∫–∞ (–ë–µ–ª—ã–π)", dice_glass: "–°—Ç–µ–∫–ª—è–Ω–Ω—ã–π", dice_neon: "–ù–µ–æ–Ω–æ–≤—ã–π", dice_gold: "–ó–æ–ª–æ—Ç–æ–π",
            lbl_tokens: "–°–ö–ò–ù–´ –§–ò–®–ï–ö:", ph_token: "–§–∏—à–∫–∞", lbl_w: "–®–∏—Ä–∏–Ω–∞:", lbl_h: "–í—ã—Å–æ—Ç–∞:",
            ph_ladder: "URL –õ–µ—Å—Ç–Ω–∏—Ü—ã", ph_snake: "URL –ó–º–µ–∏", btn_load: "–ó–ê–ì–†–£–ó–ò–¢–¨ –í–û–ü–†–û–°–´",
            lbl_q: "–í–û–ü–†–û–°–´", lbl_a: "–û–¢–í–ï–¢–´", lbl_cells: "–ö–ª–µ—Ç–∫–∏:", lbl_ladders: "–õ–µ—Å—Ç–Ω–∏—Ü—ã:", lbl_snakes: "–ó–º–µ–∏:",
            shape_circle: "–ö—Ä—É–≥", shape_square: "–ö–≤–∞–¥—Ä–∞—Ç", shape_rect: "–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫",
            col_dots: "–ö—Ä—É–∂–∫–∏", col_bg: "–¶–≤–µ—Ç –æ–∫–Ω–∞", col_txt: "–¢–µ–∫—Å—Ç –æ–∫–Ω–∞", col_btn: "–ö–Ω–æ–ø–∫–∞",
            btn_link: "–°–≤—è–∑–∞—Ç—å –∫—Ä—É–∂–∫–∏", btn_undo: "–û—Ç–º–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—è", btn_copy: "–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É", btn_iframe: "–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ iFrame", btn_reset: "–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë",
            lbl_font: "–®–†–ò–§–¢ –ò–ì–†–´:", font_hint: "* –®—Ä–∏—Ñ—Ç –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–π –∏–≥—Ä–µ",
            game_turn: "–•–û–î –ò–ì–†–û–ö–ê:", game_victory: "–ü–û–ë–ï–î–ê!", game_start: "–°–¢–ê–†–¢", game_finish: "–§–ò–ù–ò–®", modal_task: "–ó–ê–î–ê–ù–ò–ï!", btn_check: "–ü–†–û–í–ï–†–ò–¢–¨",
            lbl_latex: "MATH / LATEX ($$):"
        },
        en: {
            editor_title: "Editor",
            ph_bg: "Game Background URL", ph_modal: "Modal Background URL", ph_music: "Music URL (MP3)",
            lbl_players: "PLAYERS:", lbl_trail: "TOKEN TRAIL:", lbl_trail_color: "TRAIL COLOR",
            opt_match: "Match Token", opt_rainbow: "RAINBOW", opt_custom: "Custom", opt_none: "None",
            lbl_dice: "DICE SKIN:", dice_classic: "Classic (White)", dice_glass: "Glass", dice_neon: "Neon", dice_gold: "Gold",
            lbl_tokens: "TOKEN SKINS:", ph_token: "Token", lbl_w: "Width:", lbl_h: "Height:",
            ph_ladder: "Ladder URL", ph_snake: "Snake URL", btn_load: "LOAD QUESTIONS",
            lbl_q: "QUESTIONS", lbl_a: "ANSWERS", lbl_cells: "Cells:", lbl_ladders: "Ladders:", lbl_snakes: "Snakes:",
            shape_circle: "Circle", shape_square: "Square", shape_rect: "Rectangle",
            col_dots: "Dots", col_bg: "Modal BG", col_txt: "Modal Text", col_btn: "Button",
            btn_link: "Link Dots", btn_undo: "Undo Action", btn_copy: "Copy Link", btn_iframe: "Get iFrame", btn_reset: "Reset All",
            lbl_font: "GAME FONT:", font_hint: "* Font applies to the whole game",
            game_turn: "PLAYER TURN:", game_victory: "VICTORY!", game_start: "START", game_finish: "FINISH", modal_task: "TASK!", btn_check: "CHECK",
            lbl_latex: "MATH / LATEX ($$):"
        },
        es: {
            editor_title: "Editor",
            ph_bg: "URL Fondo del Juego", ph_modal: "URL Fondo Modal", ph_music: "URL M√∫sica (MP3)",
            lbl_players: "JUGADORES:", lbl_trail: "ESTELA:", lbl_trail_color: "COLOR ESTELA",
            opt_match: "Igualar", opt_rainbow: "ARCO√çRIS", opt_custom: "Personalizado", opt_none: "Ninguno",
            lbl_dice: "DADO:", dice_classic: "Cl√°sico", dice_glass: "Vidrio", dice_neon: "Ne√≥n", dice_gold: "Oro",
            lbl_tokens: "FICHAS:", ph_token: "Ficha", lbl_w: "Ancho:", lbl_h: "Alto:",
            ph_ladder: "URL Escalera", ph_snake: "URL Serpent", btn_load: "CARGAR PREGUNTAS",
            lbl_q: "PREGUNTAS", lbl_a: "RESPUESTAS", lbl_cells: "Celdas:", lbl_ladders: "Escaleras:", lbl_snakes: "Serpientes:",
            shape_circle: "C√≠rculo", shape_square: "Cuadrado", shape_rect: "Rect√°ngulo",
            col_dots: "Puntos", col_bg: "Fondo Modal", col_txt: "Texto Modal", col_btn: "Bot√≥n",
            btn_link: "Unir Puntos", btn_undo: "Deshacer", btn_copy: "Copiar Enlace", btn_iframe: "Obtener iFrame", btn_reset: "Reiniciar",
            lbl_font: "FUENTE:", font_hint: "* La fuente se aplica a todo el juego",
            game_turn: "TURNO JUGADOR:", game_victory: "¬°VICTORIA!", game_start: "INICIO", game_finish: "FINAL", modal_task: "¬°TAREA!", btn_check: "COMPROBAR",
            lbl_latex: "MATH / LATEX ($$):"
        },
        de: {
            editor_title: "Editor",
            ph_bg: "Spiel-Hintergrund URL", ph_modal: "Fenster-Hintergrund URL", ph_music: "Musik URL (MP3)",
            lbl_players: "SPIELER:", lbl_trail: "SCHWEIF:", lbl_trail_color: "SCHWEIF FARBE",
            opt_match: "Passend", opt_rainbow: "REGENBOGEN", opt_custom: "Benutzerdef.", opt_none: "Keiner",
            lbl_dice: "W√úRFEL:", dice_classic: "Klassisch", dice_glass: "Glas", dice_neon: "Neon", dice_gold: "Gold",
            lbl_tokens: "SPIELFIGUREN:", ph_token: "Figur", lbl_w: "Breite:", lbl_h: "H√∂he:",
            ph_ladder: "Leiter URL", ph_snake: "Schlange URL", btn_load: "FRAGEN LADEN",
            lbl_q: "FRAGEN", lbl_a: "ANTWORTEN", lbl_cells: "Zellen:", lbl_ladders: "Leitern:", lbl_snakes: "Schlangen:",
            shape_circle: "Kreis", shape_square: "Quadrat", shape_rect: "Rechteck",
            col_dots: "Punkte", col_bg: "Fenster HG", col_txt: "Fenster Text", col_btn: "Knopf",
            btn_link: "Verbinden", btn_undo: "R√ºckg√§ngig", btn_copy: "Link Kopieren", btn_iframe: "iFrame Code", btn_reset: "Alles Reset",
            lbl_font: "SCHRIFTART:", font_hint: "* Schriftart gilt f√ºr das ganze Spiel",
            game_turn: "SPIELERZUG:", game_victory: "SIEG!", game_start: "START", game_finish: "ZIEL", modal_task: "AUFGABE!", btn_check: "PR√úFEN",
            lbl_latex: "MATH / LATEX ($$):"
        },
        fr: {
            editor_title: "√âditeur",
            ph_bg: "URL Arri√®re-plan", ph_modal: "URL Fond Modal", ph_music: "URL Musique (MP3)",
            lbl_players: "JOUEURS:", lbl_trail: "TRA√éN√âE:", lbl_trail_color: "COULEUR TRA√éN√âE",
            opt_match: "Assorti", opt_rainbow: "ARC-EN-CIEL", opt_custom: "Perso", opt_none: "Aucune",
            lbl_dice: "D√â:", dice_classic: "Classique", dice_glass: "Verre", dice_neon: "N√©on", dice_gold: "Or",
            lbl_tokens: "PIONS:", ph_token: "Pion", lbl_w: "Largeur:", lbl_h: "Hauteur:",
            ph_ladder: "URL √âchelle", ph_snake: "URL Serpent", btn_load: "CHARGER QUESTIONS",
            lbl_q: "QUESTIONS", lbl_a: "R√âPONSES", lbl_cells: "Cellules:", lbl_ladders: "√âchelles:", lbl_snakes: "Serpents:",
            shape_circle: "Cercle", shape_square: "Carr√©", shape_rect: "Rectangle",
            col_dots: "Points", col_bg: "Fond Modal", col_txt: "Texte Modal", col_btn: "Bouton",
            btn_link: "Lier", btn_undo: "Annuler", btn_copy: "Copier Lien", btn_iframe: "Code iFrame", btn_reset: "R√©initialiser",
            lbl_font: "POLICE:", font_hint: "* La police s'applique √† tout le jeu",
            game_turn: "TOUR DU JOUEUR:", game_victory: "VICTOIRE !", game_start: "D√âPART", game_finish: "ARRIV√âE", modal_task: "MISSION !", btn_check: "V√âRIFIER",
            lbl_latex: "MATH / LATEX ($$):"
        }
    };

    let state = { bg: '', modalBgImg: '', music: '', tokens: ['', '', '', ''], ladderImg: '', snakeImg: '', points: [], cellSize: 60, ladderTh: 60, snakeTh: 60, tokenW: 60, tokenH: 60, tasks: [], playerCount: 4, colors: { dots: '#ffffff', modalBg: '#fff9e6', modalTxt: '#333333', btnBg: '#4CAF50', trail: '#ffffff' }, neon: true, randQ: true, cellShape: 'circle', font: 'Arial', diceSkin: 'classic', trailType: 'match', startPos: {x:100, y:150}, finishPos: {x:100, y:250}, links: [], sheetUrl: '', lang: 'ru', latex: false };
    const bgImg = new Image(), tImgs = [new Image(), new Image(), new Image(), new Image()], ladderImgObj = new Image(), snakeImgObj = new Image();
    let tPos = [{x:window.innerWidth-60,y:60,tx:window.innerWidth-60,ty:60,angle:0,isWin:false},{x:window.innerWidth-60,y:140,tx:window.innerWidth-60,ty:140,angle:0,isWin:false},{x:window.innerWidth-60,y:220,tx:window.innerWidth-60,ty:220,angle:0,isWin:false},{x:window.innerWidth-60,y:300,tx:window.innerWidth-60,ty:300,angle:0,isWin:false}];
    let dragIdx = null, isGame = false, diceVal = "?", isRoll = false, won = false, linkFrom = null, isLinkMode = false, particles = [], trailParticles = [], questionQueue = [], currentQuestionIdx = 0, pulseFrame = 0, hue = 0, currentPlayer = 0;

    const _0xSec = ["aHR0cHM6Ly9pbWcuZ2VuaWFsbHkuY29tLzY2ZjNhMzFiY2QxYTEyMDAxNTY4YWI4NS9lMmY5NzgyZi0xYmRlLTQ1ODctYWExNy0yMDBkMzg0ZDM3ZmMucG5n", "aHR0cHM6Ly92ay5jb20vYXJjZW5jaWVsbA==", "NDc1NTE3NTA="];
    function cP() { const inp = document.getElementById('pInput').value; if(btoa(inp) === _0xSec[2]) { document.getElementById('auth-screen').style.display = 'none'; document.getElementById('panel').style.display = 'block'; update(); } else { const err = document.getElementById('errMsg'); err.style.display = 'block'; document.getElementById('pInput').style.borderColor = "red"; setTimeout(()=>document.getElementById('pInput').style.borderColor = "#444", 500); } }
    function _initRes() { document.getElementById('brandImg').src = atob(_0xSec[0]); document.getElementById('brandLink').href = atob(_0xSec[1]); }

    function changeLanguage() {
        state.lang = document.getElementById('ui-language').value;
        const T = translations[state.lang];
        document.querySelectorAll('[data-t]').forEach(el => { const key = el.getAttribute('data-t'); if(T[key]) el.innerText = T[key]; });
        document.getElementById('bg-url').placeholder = T.ph_bg;
        document.getElementById('modal-bg-url').placeholder = T.ph_modal;
        document.getElementById('music-url').placeholder = T.ph_music;
        document.getElementById('ladder-url').placeholder = T.ph_ladder;
        document.getElementById('snake-url').placeholder = T.ph_snake;
        for(let i=1; i<=4; i++) document.getElementById('t'+i).placeholder = T.ph_token + " " + i;
        document.getElementById('vic-title').innerText = T.game_victory;
        document.getElementById('check-btn').innerText = T.btn_check;
        document.getElementById('modal-status').innerText = T.modal_task;
        document.getElementById('turn-indicator').innerText = T.game_turn + " " + (currentPlayer + 1);
        update();
    }

    function clearInp(id) { document.getElementById(id).value = ''; update(); }
    function playSfx(freq, type='sine', duration=0.2, volume=0.1) { if(!audioCtx) return; const osc=audioCtx.createOscillator(), gain=audioCtx.createGain(); osc.type=type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); if(type==='snake'){osc.type='sawtooth'; osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime+duration);} gain.gain.setValueAtTime(volume, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+duration); }
    function playDiceSound() { if(!audioCtx) return; for(let i=0;i<4;i++){ setTimeout(()=>{ const osc=audioCtx.createOscillator(), gain=audioCtx.createGain(); osc.type='triangle'; osc.frequency.setValueAtTime(60+Math.random()*40, audioCtx.currentTime); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.05); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime+0.05); }, i*70); } }
    function playVictorySfx() { const notes=[440,440,440,554,659]; notes.forEach((f,i)=>setTimeout(()=>playSfx(f,'triangle',0.4,0.1), [0,0.12,0.24,0.36,0.55][i]*1000)); }
    function encode(o) { return btoa(encodeURIComponent(JSON.stringify(o))); }
    function decode(s) { return JSON.parse(decodeURIComponent(atob(s))); }
    function prepareQuestions() { if(!state.tasks||state.tasks.length===0) return; questionQueue=state.tasks.map((_,i)=>i); for(let i=questionQueue.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [questionQueue[i],questionQueue[j]]=[questionQueue[j],questionQueue[i]]; } currentQuestionIdx=0; }

    function loadFromGoogle(urlOverride) { 
        let url = urlOverride || document.getElementById('sheet-url').value.trim();
        const msg = document.getElementById('loading-msg');
        if (!url) return;
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º corsproxy.io ‚Äî —ç—Ç–æ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–π –∏ "–≤—Å–µ—è–¥–Ω—ã–π" –ø—Ä–æ–∫—Å–∏
        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(url);
        
        msg.style.display = 'block';
        msg.innerText = "–ó–∞–≥—Ä—É–∑–∫–∞...";

        fetch(proxyUrl)
            .then(res => {
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ (–ö–æ–¥ ' + res.status + ')');
                return res.text();
            })
            .then(text => {
                // –ï—Å–ª–∏ –ø—Ä–æ–∫—Å–∏ –≤–µ—Ä–Ω—É–ª HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ—à–∏–±–∫–∏ –∏–ª–∏ –∫–∞–ø—á—É, –∞ –Ω–µ CSV
                if(text.trim().startsWith("<!DOCTYPE") || text.includes("<html")) {
                    throw new Error("–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Å—ã–ª–∫—É (–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å CSV).");
                }

                const rows = text.split(/\r?\n/);
                let qT = "", aT = "";
                rows.forEach((row, idx) => {
                    if (!row.trim() || idx === 0) return; // –ü—Ä–æ–ø—É—Å–∫ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                    const pts = row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    if (pts && pts.length >= 1) {
                        let q = pts[0].replace(/^"|"$/g, '').trim();
                        let a = pts.length > 1 ? pts[1].replace(/^"|"$/g, '').trim() : '';
                        if (q) { qT += q + "\n"; aT += a + "\n"; }
                    }
                });
                
                if (qT.length === 0) { throw new Error("–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ –ø—Ä–æ—á–∏—Ç–∞–Ω–∞."); }

                document.getElementById('qs').value = qT.trim();
                document.getElementById('ans').value = aT.trim();
                update();
                msg.innerText = "OK!";
                setTimeout(() => { msg.style.display = 'none'; msg.innerText = "..."; }, 2000);
            })
            .catch(e => {
                console.error(e);
                msg.innerText = "ERR!";
                msg.style.color = "#ff5555";
                setTimeout(() => { msg.style.display = 'none'; msg.style.color = "#4CAF50"; }, 6000);
            });
    }
    
    function init() { 
        window.addEventListener('resize', resize); resize(); 
        const p=new URLSearchParams(window.location.search), d=p.get('game'); 
        _initRes(); 
        if(d){ 
            try{ 
                state=decode(d); isGame=true; 
                document.getElementById('auth-screen').style.display='none'; 
                document.getElementById('panel').style.display='none'; 
                document.getElementById('turn-indicator').style.display='block'; 
                if(state.sheetUrl) loadFromGoogle(state.sheetUrl); 
            }catch(e){console.error(e);} 
        } else {
            document.getElementById('auth-screen').style.display='flex';
        }
        
        if(!state.lang) state.lang = 'ru';
        document.getElementById('ui-language').value = state.lang;
        document.getElementById('latex-on').checked = state.latex; // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–∞–ª–æ—á–∫–∏
        changeLanguage(); 

        document.body.style.fontFamily=state.font; document.getElementById('vic-title').style.fontFamily=state.font; if(state.music) bgMusic.src=state.music; if(state.tokenW) document.getElementById('token-w').value=state.tokenW; if(state.tokenH) document.getElementById('token-h').value=state.tokenH; if(state.sheetUrl) document.getElementById('sheet-url').value=state.sheetUrl; applyStateToAssets(); prepareQuestions(); update(); animate(); 
    }
    
    function applyStateToAssets() { if(state.bg)bgImg.src=state.bg; if(state.ladderImg)ladderImgObj.src=state.ladderImg; if(state.snakeImg)snakeImgObj.src=state.snakeImg; state.tokens.forEach((u,i)=>{if(u)tImgs[i].src=u;}); }
    function animate() { pulseFrame+=0.035; hue=(hue+2)%360; tPos.forEach((p,i)=>{ let oX=p.x, oY=p.y; p.x+=(p.tx-p.x)*0.35; p.y+=(p.ty-p.y)*0.35; if(p.isWin)p.angle+=0.2; if(state.trailType!=='none'&&Math.hypot(p.x-oX,p.y-oY)>0.1){ let c; if(state.trailType==='rainbow')c=`hsl(${hue},100%,70%)`; else if(state.trailType==='custom')c=state.colors.trail; else c=['#ff4d4d','#4d4dff','#4dff4d','#ffff4d'][i]; for(let k=0;k<2;k++) trailParticles.push({x:p.x+(Math.random()-0.5)*15,y:p.y+(Math.random()-0.5)*15,vx:(Math.random()-0.5),vy:(Math.random()-0.5),life:1.0,color:c,size:Math.random()*2+1}); } }); trailParticles.forEach((p,i)=>{p.x+=p.vx; p.y+=p.vy; p.life-=0.02; if(p.life<=0)trailParticles.splice(i,1);}); draw(); if(won){ cnfCtx.clearRect(0,0,cnfCvs.width,cnfCvs.height); particles.forEach((p,i)=>{p.x+=p.vx; p.y+=p.vy; p.vy+=p.gravity; cnfCtx.fillStyle=p.color; cnfCtx.beginPath(); cnfCtx.arc(p.x,p.y,p.r,0,7); cnfCtx.fill(); if(p.y>cnfCvs.height+50)particles.splice(i,1);}); if(Math.random()>0.6)for(let i=0;i<5;i++)particles.push({x:cnfCvs.width/2,y:cnfCvs.height/2,vx:(Math.random()-0.5)*20,vy:(Math.random()-0.7)*20,color:`hsl(${Math.random()*360},100%,50%)`,r:Math.random()*5+2,gravity:0.2}); } requestAnimationFrame(animate); }
    function toggleLinkMode() { isLinkMode=!isLinkMode; linkFrom=null; document.getElementById('link-btn').style.background=isLinkMode?"#e91e63":"#9c27b0"; }

    function undo() {
        if(actHist.length === 0) return;
        const lastAction = actHist.pop();
        if (lastAction === 'link') { state.links.pop(); } 
        else if (lastAction === 'point') { state.points.pop(); const deadIdx = state.points.length; state.links = state.links.filter(l => l.from !== deadIdx && l.to !== deadIdx); }
        draw(); update();
    }

    function roll() {
        if (isRoll || won) return;
        isRoll = true; playDiceSound();
        if(bgMusic.paused && state.music) bgMusic.play().catch(()=>{});
        let c = 0;
        const iv = setInterval(() => { 
            diceVal = Math.floor(Math.random() * 6) + 1; 
            if (++c > 12) { 
                clearInterval(iv); 
                isRoll = false; 
                setTimeout(() => {
                    const qVal = document.getElementById('qs').value;
                    const aVal = document.getElementById('ans').value;
                    const finishTurn = () => {
                        showTask(); 
                        if(isGame) { 
                            currentPlayer = (currentPlayer + 1) % state.playerCount; 
                            document.getElementById('turn-indicator').innerText = translations[state.lang].game_turn + " " + (currentPlayer + 1); 
                        }
                    };
                    if (qVal.trim().length > 0) {
                        const qs = qVal.split('\n'), ans = aVal.split('\n');
                        state.tasks = qs.map((q, i) => ({ q: q.trim(), a: (ans[i] || '').trim() })).filter(t => t.q);
                        prepareQuestions(); finishTurn();
                    } 
                    else if (state.sheetUrl) {
                        // –¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è —Ö–æ–¥–∞ –∏–≥—Ä—ã ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º corsproxy.io
                        const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(state.sheetUrl);
                        fetch(proxyUrl).then(res=>res.text()).then(text=>{ 
                            const rows=text.split(/\r?\n/); let newTasks=[]; 
                            rows.forEach((row, idx)=>{ 
                                if(!row.trim() || idx === 0)return; 
                                const pts=row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                                if(pts&&pts.length>=1){ 
                                    let q=pts[0].replace(/^"|"$/g,'').trim(), a=pts.length>1?pts[1].replace(/^"|"$/g,'').trim():''; 
                                    if(q) newTasks.push({q:q, a:a}); 
                                } 
                            }); 
                            if(newTasks.length > 0) { state.tasks = newTasks; prepareQuestions(); }
                            finishTurn();
                        }).catch(e=>{ console.error("–û—à–∏–±–∫–∞ Google:", e); finishTurn(); }); 
                    } else { finishTurn(); }
                }, 400); 
            } 
        }, 60);
    }

    function showTask() {
        if (!state.tasks || !state.tasks.length) return;
        if (questionQueue.length === 0) prepareQuestions();
        const tIdx = questionQueue[0], m = document.getElementById('task-modal');
        m.style.backgroundColor = state.colors.modalBg;
        if(state.modalBgImg) m.style.backgroundImage = `url(${state.modalBgImg})`; else m.style.backgroundImage = 'none';
        m.style.color = state.colors.modalTxt; m.style.fontFamily = state.font;
        
        // --- MATH / LATEX RENDERING ---
        const qText = state.tasks[tIdx].q;
        const qEl = document.getElementById('task-question');
        if (state.latex) {
            qEl.innerHTML = qText; // –†–∞–∑—Ä–µ—à–∞–µ–º HTML –¥–ª—è —Ñ–æ—Ä–º—É–ª
            MathJax.typesetPromise([qEl]).catch((err) => console.log(err));
        } else {
            qEl.innerText = qText; // –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç
        }
        
        document.getElementById('check-btn').style.backgroundColor = state.colors.btnBg;
        m.setAttribute('data-ans-idx', tIdx); m.classList.add('show');
        const inp = document.getElementById('answer-input'); inp.value = ""; setTimeout(()=>inp.focus(),100);
    }
    function closeModal() { document.getElementById('task-modal').classList.remove('show'); }
    function checkAnswer() { 
        const m = document.getElementById('task-modal'), tIdx = parseInt(m.getAttribute('data-ans-idx')), input = document.getElementById('answer-input'); 
        if (input.value.trim().toLowerCase() === state.tasks[tIdx].a.toLowerCase()) { 
            m.classList.remove('show', 'modal-error'); playSfx(600); questionQueue.shift(); input.value = ""; 
        } else { 
            playSfx(100, 'sawtooth'); m.classList.remove('modal-error'); void m.offsetWidth; m.classList.add('modal-error'); setTimeout(() => m.classList.remove('modal-error'), 500);
        } 
    }
    function update() { 
        if(isGame)return; 
        state.bg=document.getElementById('bg-url').value; 
        state.modalBgImg=document.getElementById('modal-bg-url').value; 
        const nM=document.getElementById('music-url').value; if(nM!==state.music){state.music=nM; bgMusic.src=nM;} 
        state.ladderImg=document.getElementById('ladder-url').value; 
        state.snakeImg=document.getElementById('snake-url').value; 
        state.tokens=[document.getElementById('t1').value,document.getElementById('t2').value,document.getElementById('t3').value,document.getElementById('t4').value]; 
        state.cellSize=parseInt(document.getElementById('cell-size').value); 
        state.ladderTh=parseInt(document.getElementById('ladder-th').value); 
        state.snakeTh=parseInt(document.getElementById('snake-th').value); 
        state.tokenW=parseInt(document.getElementById('token-w').value); 
        state.tokenH=parseInt(document.getElementById('token-h').value); 
        state.neon=document.getElementById('neon-on').checked; 
        state.cellShape=document.getElementById('cell-shape').value; 
        state.font=document.getElementById('game-font').value; 
        state.diceSkin=document.getElementById('dice-skin').value; 
        state.trailType=document.getElementById('trail-type').value; 
        state.playerCount=parseInt(document.getElementById('p-count').value); 
        state.sheetUrl=document.getElementById('sheet-url').value; 
        state.colors={dots:document.getElementById('c-dots').value,modalBg:document.getElementById('c-bg').value,modalTxt:document.getElementById('c-txt').value,btnBg:document.getElementById('c-btn').value,trail:document.getElementById('c-trail').value}; 
        state.lang = document.getElementById('ui-language').value; 
        state.latex = document.getElementById('latex-on').checked; // –°–æ—Ö—Ä–∞–Ω—è–µ–º Latex
        
        document.getElementById('sz-val').innerText=state.cellSize; 
        document.getElementById('l-th-val').innerText=state.ladderTh; 
        document.getElementById('s-th-val').innerText=state.snakeTh; 
        document.getElementById('tw-val').innerText=state.tokenW; 
        document.getElementById('th-val').innerText=state.tokenH; 
        document.getElementById('font-preview').style.fontFamily=state.font; 
        
        const qs=document.getElementById('qs').value.split('\n'), ans=document.getElementById('ans').value.split('\n'); 
        state.tasks=qs.map((q,i)=>({q:q.trim(),a:(ans[i]||'').trim()})).filter(t=>t.q); 
        applyStateToAssets(); 
    }

    function draw() { 
        ctx.clearRect(0,0,cvs.width,cvs.height); 
        if(bgImg.src&&bgImg.complete)ctx.drawImage(bgImg,0,0,cvs.width,cvs.height); 
        trailParticles.forEach(p=>{ctx.globalAlpha=p.life; ctx.fillStyle=p.color; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,7); ctx.fill();}); 
        ctx.globalAlpha=1.0; 
        state.links.forEach(l=>{ const f=state.points[l.from], t=state.points[l.to]; if(f&&t){ const x1=f.x*cvs.width, y1=f.y*cvs.height, x2=t.x*cvs.width, y2=t.y*cvs.height, dist=Math.hypot(x2-x1,y2-y1), ang=Math.atan2(y2-y1,x2-x1), isL=(y2<y1); let im=isL?ladderImgObj:snakeImgObj, th=isL?state.ladderTh:state.snakeTh; if(im.complete&&im.src){ctx.save(); ctx.translate(x1,y1); ctx.rotate(ang+Math.PI/2); ctx.drawImage(im,-th/2,-dist,th,dist); ctx.restore();} } }); 
        state.points.forEach((p,i)=>{ const px=p.x*cvs.width, py=p.y*cvs.height, s=state.cellSize, hasT=tPos.some(tp=>Math.hypot(tp.x-px,tp.y-py)<15), bC=hasT?`hsl(${hue},100%,60%)`:(linkFrom===i?"#e91e63":p.type==='skip'?"#f44336":p.type==='boost'?"#4CAF50":p.type==='task'?"#2196F3":state.colors.dots); ctx.save(); if(state.neon){ctx.shadowBlur=hasT?35:15; ctx.shadowColor=bC;} ctx.fillStyle="rgba(255,255,255,0.15)"; ctx.beginPath(); if(state.cellShape==='circle')ctx.arc(px,py,s/2,0,7); else if(state.cellShape==='square')ctx.roundRect(px-s/2,py-s/2,s,s,10); else ctx.roundRect(px-s,py-s/2,s*2,s,10); ctx.fill(); const g=ctx.createRadialGradient(px,py,s/6,px,py,s/1.4); g.addColorStop(0,"rgba(255,255,255,0)"); g.addColorStop(1,bC.replace('rgb','rgba').replace(')',',0.4)')); ctx.fillStyle=g; ctx.fill(); ctx.strokeStyle="rgba(255,255,255,0.6)"; ctx.lineWidth=2; ctx.stroke(); ctx.strokeStyle=bC; ctx.lineWidth=1; ctx.stroke(); ctx.fillStyle="white"; ctx.beginPath(); if(state.cellShape==='circle')ctx.arc(px-s/4.5,py-s/4.5,s/8,0,7); else ctx.ellipse(px-s/1.5,py-s/4.5,s/6,s/10,Math.PI/4,0,7); ctx.fill(); ctx.restore(); if(!isGame){ctx.fillStyle="white"; ctx.font="14px Arial"; ctx.textAlign="center"; ctx.fillText(i+1,px,py+5);} }); 
        
        const T = translations[state.lang] || translations.ru;
        ctx.font = `bold 40px ${state.font}`; ctx.fillStyle = state.colors.dots; ctx.textAlign = "center"; 
        ctx.fillText(T.game_start, state.startPos.x, state.startPos.y); 
        ctx.fillText(T.game_finish, state.finishPos.x, state.finishPos.y); 
        
        for(let i=0;i<(isGame?state.playerCount:4);i++){ let tw=state.tokenW, th=state.tokenH; if(isGame&&i===currentPlayer&&!won){tw+=Math.sin(pulseFrame)*8; th+=Math.sin(pulseFrame)*8;} ctx.save(); ctx.translate(tPos[i].x,tPos[i].y); ctx.rotate(tPos[i].angle); if(state.tokens[i]&&tImgs[i].complete)ctx.drawImage(tImgs[i],-tw/2,-th/2,tw,th); else {ctx.fillStyle=['red','blue','green','yellow'][i]; ctx.beginPath(); ctx.arc(0,0,state.cellSize/3,0,7); ctx.fill();} ctx.restore(); } const dx=cvs.width-110, dy=cvs.height-110; ctx.save(); if(state.diceSkin==='glass'){ctx.fillStyle="rgba(255,255,255,0.3)"; ctx.strokeStyle="rgba(255,255,255,0.8)"; ctx.lineWidth=2;} else if(state.diceSkin==='neon'){ctx.fillStyle="#000"; ctx.strokeStyle=state.colors.dots; ctx.lineWidth=4; ctx.shadowBlur=15; ctx.shadowColor=state.colors.dots;} else if(state.diceSkin==='gold'){ctx.fillStyle="gold"; ctx.strokeStyle="#b8860b"; ctx.lineWidth=3;} else ctx.fillStyle="white"; ctx.beginPath(); ctx.roundRect(dx,dy,90,90,15); ctx.fill(); if(state.diceSkin!=='classic')ctx.stroke(); ctx.shadowBlur=0; ctx.fillStyle=(state.diceSkin==='gold'||state.diceSkin==='classic')?"#333":"white"; ctx.font=`bold 55px ${state.font}`; ctx.textAlign="center"; ctx.fillText(diceVal,dx+45,dy+65); ctx.restore(); 
    }

    cvs.onmousedown=(e)=>{ if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)(); if(audioCtx.state==='suspended')audioCtx.resume(); const x=e.clientX, y=e.clientY; if(x>cvs.width-110&&y>cvs.height-110){roll(); return;} for(let i=0;i<state.playerCount;i++)if(Math.hypot(x-tPos[i].x,y-tPos[i].y)<state.tokenW/2){dragIdx='t'+i; return;} if(Math.hypot(x-state.startPos.x,y-state.startPos.y)<50){dragIdx='start'; return;} if(Math.hypot(x-state.finishPos.x,y-state.finishPos.y)<50){dragIdx='finish'; return;} for(let i=0;i<state.points.length;i++){ if(Math.hypot(x-state.points[i].x*cvs.width,y-state.points[i].y*cvs.height)<state.cellSize/2){ if(isLinkMode){if(linkFrom===null)linkFrom=i; else if(linkFrom!==i){
        state.links.push({from:linkFrom,to:i}); actHist.push('link'); linkFrom=null; update();}} else if(!isGame)dragIdx='p'+i; return; } } 
        if(!isGame&&!isLinkMode){ state.points.push({x:x/cvs.width,y:y/cvs.height,type:'normal'}); actHist.push('point'); update(); } 
    };
    
    window.oncontextmenu=(e)=>{ e.preventDefault(); if(isGame)return; state.points.forEach(p=>{if(Math.hypot(e.clientX-p.x*cvs.width,e.clientY-p.y*cvs.height)<state.cellSize/2){const ts=['normal','skip','boost','task']; p.type=ts[(ts.indexOf(p.type||'normal')+1)%ts.length]; update(); playSfx(400);}}); };
    cvs.onmousemove=(e)=>{ if(!dragIdx)return; if(dragIdx==='start')state.startPos={x:e.clientX,y:e.clientY}; else if(dragIdx==='finish')state.finishPos={x:e.clientX,y:e.clientY}; else if(dragIdx.startsWith('t')){tPos[dragIdx[1]].tx=e.clientX; tPos[dragIdx[1]].ty=e.clientY;} else if(dragIdx.startsWith('p'))state.points[dragIdx.substring(1)]={x:e.clientX/cvs.width,y:e.clientY/cvs.height}; update(); };
    cvs.onmouseup=()=>{ if(dragIdx&&dragIdx.startsWith('t')){ const idx=dragIdx[1]; if(Math.hypot(tPos[idx].tx-state.finishPos.x,tPos[idx].ty-state.finishPos.y)<60){won=true; tPos[idx].isWin=true; playVictorySfx(); document.getElementById('victory-overlay').style.display='flex';} state.points.forEach((p,pIdx)=>{ if(Math.hypot(tPos[idx].tx-p.x*cvs.width,tPos[idx].ty-p.y*cvs.height)<50){ tPos[idx].tx=p.x*cvs.width; tPos[idx].ty=p.y*cvs.height; if(isGame){if(p.type==='task')setTimeout(showTask,500); if(p.type==='boost')playSfx(900); if(p.type==='skip')playSfx(50,'sawtooth');} const l=state.links.find(li=>li.from===pIdx); if(l){const iL=state.points[l.from].y>state.points[l.to].y; setTimeout(()=>{playSfx(iL?1000:200,iL?'sine':'snake'); tPos[idx].tx=state.points[l.to].x*cvs.width; tPos[idx].ty=state.points[l.to].y*cvs.height;},500);} } }); } dragIdx=null; update(); };
    function resize(){cvs.width=window.innerWidth; cvs.height=window.innerHeight; cnfCvs.width=window.innerWidth; cnfCvs.height=window.innerHeight;}
    function save(){ let s=JSON.parse(JSON.stringify(state)); s.points=s.points.map(p=>({x:Math.round(p.x*1000)/1000,y:Math.round(p.y*1000)/1000,type:p.type})); s.startPos={x:Math.round(s.startPos.x),y:Math.round(s.startPos.y)}; s.finishPos={x:Math.round(s.finishPos.x),y:Math.round(s.finishPos.y)}; if(s.sheetUrl)s.tasks=[]; const u=window.location.href.split('?')[0]+"?game="+encode(s); navigator.clipboard.writeText(u); alert(translations[state.lang].btn_copy + " OK!"); return u; }
    function getIframe(){ const u=save(), c=`<iframe src="${u}" width="100%" height="600" style="border:none;" allow="autoplay"></iframe>`; navigator.clipboard.writeText(c); alert(translations[state.lang].btn_iframe + " OK!"); }
    init();

    // üî• –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê (–ñ–µ–ª–µ–∑–Ω–∞—è –°—Ç–µ–Ω–∞) üî•
    document.onselectstart = function() { return false; }; 
    document.ondragstart = function() { return false; };    

    document.onkeydown = function(e) {
        if (e.keyCode == 123) return false; 
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
        if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
        if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; 
        if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) return false; 
        if (e.ctrlKey && e.keyCode == 'C'.charCodeAt(0)) return false; 
        if (e.ctrlKey && e.keyCode == 'A'.charCodeAt(0)) return false; 
    };
    console.log("%cProtected Content", "color: red; font-size: 20px; font-weight: bold;");
</script>
</body>
</html>
